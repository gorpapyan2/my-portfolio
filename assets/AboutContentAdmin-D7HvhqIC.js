import{c as pe,r as t,v as m,ar as be,as as j,u as ye,j as e,T as O}from"./index-siMbvs9L.js";import{P as F}from"./plus-YjYhcHqF.js";import{T as ee}from"./trash-2-ClcjC_9b.js";import{I as fe}from"./ImageUpload--9VRgsHr.js";import{A as ve,L as _e}from"./AdminLoadingState-BlNnS30Y.js";import"./upload-DvK9RWp_.js";const ae=pe("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]),Y="about_portrait";async function S(o){const{data:u,error:s}=await m.from(o).select("id,order_index").order("order_index",{ascending:!0});if(s)throw s;return u??[]}async function k(o,u){const{data:s,error:l}=await m.from(o).select("*").eq("language",u);if(l)throw l;return s??[]}function D(o,u,s,l){const v=new Map;return u.forEach(h=>{const b=h[s],i=h[l];b&&i&&v.set(b,i)}),o.map(h=>({id:h.id,order_index:h.order_index,value:v.get(h.id)??""}))}function Ne(o,u){const s=new Map;return u.forEach(l=>{l.about_language_id&&l.name&&s.set(l.about_language_id,{name:l.name,level:l.level})}),o.map(l=>({id:l.id,order_index:l.order_index,name:s.get(l.id)?.name??"",level:s.get(l.id)?.level??""}))}function je(o,u){const[s,l]=t.useState(o),[v,h]=t.useState(!0),[b,i]=t.useState(null),[w,C]=t.useState(null),[J,_]=t.useState(null),[M,E]=t.useState(!0),[W,T]=t.useState(!1),[L,A]=t.useState([]),[K,P]=t.useState([]),[R,V]=t.useState([]),[I,B]=t.useState([]),[n,c]=t.useState([]),[y,p]=t.useState(""),[N,te]=t.useState(""),[$,se]=t.useState(""),[G,ne]=t.useState(""),[q,Q]=t.useState(""),[z,X]=t.useState(""),re=t.useMemo(()=>[{id:"journey",label:u("about.professionalJourney"),base:"about_professional_journey",translation:"about_professional_journey_translations",foreignKey:"journey_id",valueKey:"text",items:L,setItems:A,newValue:y,setNewValue:p},{id:"philosophy",label:u("about.philosophy"),base:"about_philosophy",translation:"about_philosophy_translations",foreignKey:"philosophy_id",valueKey:"text",items:K,setItems:P,newValue:N,setNewValue:te},{id:"toolbox",label:u("about.toolbox"),base:"about_toolbox_items",translation:"about_toolbox_translations",foreignKey:"toolbox_item_id",valueKey:"label",items:R,setItems:V,newValue:$,setNewValue:se},{id:"keyResults",label:u("about.keyResults.title"),base:"about_key_results",translation:"about_key_result_translations",foreignKey:"key_result_id",valueKey:"summary",items:I,setItems:B,newValue:G,setNewValue:ne}],[L,K,R,I,y,N,$,G,u]),Z=t.useCallback(async()=>{try{E(!0),_(null);const{data:a,error:r}=await m.from("site_assets").select("*").eq("key",Y).maybeSingle();if(r)throw r;C(a??null)}catch(a){const r=a instanceof Error?a.message:"Failed to load portrait asset";_(r)}finally{E(!1)}},[]),g=t.useCallback(async()=>{try{h(!0),i(null);const[a,r,d,x,f,H,U,me,he,xe]=await Promise.all([S("about_professional_journey"),k("about_professional_journey_translations",s),S("about_philosophy"),k("about_philosophy_translations",s),S("about_toolbox_items"),k("about_toolbox_translations",s),S("about_key_results"),k("about_key_result_translations",s),S("about_languages"),k("about_language_translations",s)]);A(D(a,r,"journey_id","text")),P(D(d,x,"philosophy_id","text")),V(D(f,H,"toolbox_item_id","label")),B(D(U,me,"key_result_id","summary")),c(Ne(he,xe))}catch(a){const r=a instanceof Error?a.message:"Failed to load About content";i(r)}finally{h(!1)}},[s]);t.useEffect(()=>{g()},[g]),t.useEffect(()=>{Z()},[Z]);const le=t.useCallback(async(a,r,d)=>{try{T(!0),_(null);const x=w?.storage_path??null,f=d??x,{data:H,error:U}=await m.from("site_assets").upsert({key:Y,url:a,storage_path:f},{onConflict:"key"}).select("*").single();if(U)throw U;C(H),be(Y),x&&f&&x!==f&&await m.storage.from("images").remove([x])}catch(x){const f=x instanceof Error?x.message:"Failed to update portrait asset";_(f)}finally{T(!1)}},[w?.storage_path]),oe=t.useCallback(async a=>{if(!a.newValue.trim())return;const{data:r,error:d}=await m.from(a.base).insert({order_index:a.items.length+1}).select("id,order_index").single();if(d){i(d.message);return}const{error:x}=await m.from(a.translation).insert({[a.foreignKey]:r.id,language:s,[a.valueKey]:a.newValue.trim()});if(x){i(x.message);return}a.setNewValue(""),j(),await g()},[s,g]),ie=t.useCallback(async(a,r)=>{const{error:d}=await m.from(a.translation).upsert({[a.foreignKey]:r.id,language:s,[a.valueKey]:r.value.trim()},{onConflict:`${a.foreignKey},language`});if(d){i(d.message);return}j(),await g()},[s,g]),ue=t.useCallback(async(a,r)=>{const{error:d}=await m.from(a.base).delete().eq("id",r);if(d){i(d.message);return}j(),await g()},[g]),de=t.useCallback(async()=>{if(!q.trim())return;const{data:a,error:r}=await m.from("about_languages").insert({order_index:n.length+1}).select("id,order_index").single();if(r){i(r.message);return}const{error:d}=await m.from("about_language_translations").insert({about_language_id:a.id,language:s,name:q.trim(),level:z.trim()||null});if(d){i(d.message);return}Q(""),X(""),j(),await g()},[s,n.length,g,q,z]),ce=t.useCallback(async a=>{const{error:r}=await m.from("about_language_translations").upsert({about_language_id:a.id,language:s,name:a.name.trim(),level:a.level?.trim()||null},{onConflict:"about_language_id,language"});if(r){i(r.message);return}j(),await g()},[s,g]),ge=t.useCallback(async a=>{const{error:r}=await m.from("about_languages").delete().eq("id",a);if(r){i(r.message);return}j(),await g()},[g]);return{activeLanguage:s,setActiveLanguage:l,loading:v,error:b,portraitAsset:w,portraitError:J,portraitLoading:M,portraitSaving:W,handlePortraitUpload:le,sectionConfig:re,handleAddText:oe,handleSaveText:ie,handleDeleteText:ue,languagesState:n,setLanguagesState:c,handleAddLanguage:de,handleSaveLanguage:ce,handleDeleteLanguage:ge,newLanguageName:q,setNewLanguageName:Q,newLanguageLevel:z,setNewLanguageLevel:X}}function Te(){const{t:o,language:u}=ye(),{activeLanguage:s,setActiveLanguage:l,loading:v,error:h,portraitAsset:b,portraitError:i,portraitLoading:w,portraitSaving:C,handlePortraitUpload:J,sectionConfig:_,handleAddText:M,handleSaveText:E,handleDeleteText:W,languagesState:T,setLanguagesState:L,handleAddLanguage:A,handleSaveLanguage:K,handleDeleteLanguage:P,newLanguageName:R,setNewLanguageName:V,newLanguageLevel:I,setNewLanguageLevel:B}=je(u,o);return v?e.jsx(ve,{shimmerWidth:"120px"}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-[length:var(--font-600)] font-semibold text-[var(--text)]",children:e.jsx(O,{translationKey:"admin.about.title",as:"span",shimmerWidth:"200px"})}),e.jsx(_e,{value:s,onChange:l})]}),h&&e.jsx("div",{className:"text-red-400 text-[length:var(--font-100)]",children:h}),e.jsx("p",{className:"text-[var(--text-muted)] text-[length:var(--font-100)]",children:o("admin.about.markdownHint")}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-[length:var(--font-400)] font-medium text-[var(--text)]",children:"Portrait Image"}),i&&e.jsx("div",{className:"text-red-400 text-[length:var(--font-100)]",children:i}),w?e.jsx("div",{className:"text-[var(--text)]",children:e.jsx(O,{translationKey:"admin.common.loading",as:"span",shimmerWidth:"120px"})}):e.jsxs("div",{className:"space-y-2",children:[e.jsx(fe,{currentImage:b?.url??"",onUpload:J,folder:"portrait",disabled:C}),b?.url?e.jsxs("div",{className:"text-[length:var(--font-100)] text-[var(--text-muted)] break-all",children:["Current URL: ",b.url]}):null]})]}),_.map(n=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-[length:var(--font-400)] font-medium text-[var(--text)]",children:n.label}),e.jsx("div",{className:"space-y-2",children:n.items.map(c=>e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("textarea",{value:c.value,onChange:y=>n.setItems(p=>p.map(N=>N.id===c.id?{...N,value:y.target.value}:N)),className:"field flex-1",rows:2}),e.jsx("button",{type:"button",onClick:()=>E(n,c),className:"btn btn-primary",children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>W(n,c.id),className:"btn btn-secondary",children:e.jsx(ee,{className:"h-4 w-4"})})]},c.id))}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("textarea",{value:n.newValue,onChange:c=>n.setNewValue(c.target.value),className:"field flex-1",rows:2,placeholder:o("admin.common.addNew")}),e.jsx("button",{type:"button",onClick:()=>M(n),className:"btn btn-primary",children:e.jsx(F,{className:"h-4 w-4"})})]})]},n.id)),e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-[length:var(--font-400)] font-medium text-[var(--text)]",children:e.jsx(O,{translationKey:"about.languages.title",as:"span",shimmerWidth:"160px"})}),e.jsx("div",{className:"space-y-2",children:T.map(n=>e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[2fr_1fr_auto_auto] gap-2 items-start",children:[e.jsx("input",{value:n.name,onChange:c=>L(y=>y.map(p=>p.id===n.id?{...p,name:c.target.value}:p)),className:"field",placeholder:o("admin.about.languageName")}),e.jsx("input",{value:n.level??"",onChange:c=>L(y=>y.map(p=>p.id===n.id?{...p,level:c.target.value}:p)),className:"field",placeholder:o("admin.about.languageLevel")}),e.jsx("button",{type:"button",onClick:()=>K(n),className:"btn btn-primary",children:e.jsx(ae,{className:"h-4 w-4"})}),e.jsx("button",{type:"button",onClick:()=>P(n.id),className:"btn btn-secondary",children:e.jsx(ee,{className:"h-4 w-4"})})]},n.id))}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[2fr_1fr_auto] gap-2 items-start",children:[e.jsx("input",{value:R,onChange:n=>V(n.target.value),className:"field",placeholder:o("admin.about.languageName")}),e.jsx("input",{value:I,onChange:n=>B(n.target.value),className:"field",placeholder:o("admin.about.languageLevel")}),e.jsx("button",{type:"button",onClick:A,className:"btn btn-primary",children:e.jsx(F,{className:"h-4 w-4"})})]})]})]})}export{Te as AboutContentAdmin};
