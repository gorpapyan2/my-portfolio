import{c as pe,u as be,r as s,s as d,j as a,T as N,I as ye,J as x}from"./index-CkwioJsN.js";import{T as G,P as Q}from"./trash-2-Dqo3gUTr.js";import{I as fe}from"./ImageUpload-CMlqmZXI.js";import"./upload-BqyikKsD.js";const X=pe("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]),_e=[{code:"en",label:"English"},{code:"ru",label:"Russian"},{code:"am",label:"Armenian"}],C="about_portrait";async function b(r){const{data:m,error:n}=await d.from(r).select("id,order_index").order("order_index",{ascending:!0});if(n)throw n;return m??[]}async function y(r,m){const{data:n,error:i}=await d.from(r).select("*").eq("language",m);if(i)throw i;return n??[]}function w(r,m,n,i){const f=new Map;return m.forEach(g=>{const p=g[n],u=g[i];p&&u&&f.set(p,u)}),r.map(g=>({id:g.id,order_index:g.order_index,value:f.get(g.id)??""}))}function ve(r,m){const n=new Map;return m.forEach(i=>{i.about_language_id&&i.name&&n.set(i.about_language_id,{name:i.name,level:i.level})}),r.map(i=>({id:i.id,order_index:i.order_index,name:n.get(i.id)?.name??"",level:n.get(i.id)?.level??""}))}function ke(){const{t:r,language:m}=be(),[n,i]=s.useState(m),[f,g]=s.useState(!0),[p,u]=s.useState(null),[_,K]=s.useState(null),[L,v]=s.useState(null),[Z,T]=s.useState(!0),[ee,R]=s.useState(!1),[P,A]=s.useState([]),[I,V]=s.useState([]),[B,q]=s.useState([]),[J,M]=s.useState([]),[U,S]=s.useState([]),[W,ae]=s.useState(""),[F,te]=s.useState(""),[z,se]=s.useState(""),[D,ne]=s.useState(""),[k,H]=s.useState(""),[O,Y]=s.useState(""),le=s.useMemo(()=>[{id:"journey",label:r("about.professionalJourney"),base:"about_professional_journey",translation:"about_professional_journey_translations",foreignKey:"journey_id",valueKey:"text",items:P,setItems:A,newValue:W,setNewValue:ae},{id:"philosophy",label:r("about.philosophy"),base:"about_philosophy",translation:"about_philosophy_translations",foreignKey:"philosophy_id",valueKey:"text",items:I,setItems:V,newValue:F,setNewValue:te},{id:"toolbox",label:r("about.toolbox"),base:"about_toolbox_items",translation:"about_toolbox_translations",foreignKey:"toolbox_item_id",valueKey:"label",items:B,setItems:q,newValue:z,setNewValue:se},{id:"keyResults",label:r("about.keyResults.title"),base:"about_key_results",translation:"about_key_result_translations",foreignKey:"key_result_id",valueKey:"summary",items:J,setItems:M,newValue:D,setNewValue:ne}],[P,I,B,J,W,F,z,D,r]),$=s.useCallback(async()=>{try{T(!0),v(null);const{data:e,error:t}=await d.from("site_assets").select("*").eq("key",C).maybeSingle();if(t)throw t;K(e??null)}catch(e){const t=e instanceof Error?e.message:"Failed to load portrait asset";v(t)}finally{T(!1)}},[]),h=s.useCallback(async()=>{try{g(!0),u(null);const[e,t,o,l,c,E,j,ge,he,xe]=await Promise.all([b("about_professional_journey"),y("about_professional_journey_translations",n),b("about_philosophy"),y("about_philosophy_translations",n),b("about_toolbox_items"),y("about_toolbox_translations",n),b("about_key_results"),y("about_key_result_translations",n),b("about_languages"),y("about_language_translations",n)]);A(w(e,t,"journey_id","text")),V(w(o,l,"philosophy_id","text")),q(w(c,E,"toolbox_item_id","label")),M(w(j,ge,"key_result_id","summary")),S(ve(he,xe))}catch(e){const t=e instanceof Error?e.message:"Failed to load About content";u(t)}finally{g(!1)}},[n]);s.useEffect(()=>{h()},[h]),s.useEffect(()=>{$()},[$]);const oe=async(e,t,o)=>{try{R(!0),v(null);const l=_?.storage_path??null,c=o??l,{data:E,error:j}=await d.from("site_assets").upsert({key:C,url:e,storage_path:c},{onConflict:"key"}).select("*").single();if(j)throw j;K(E),ye(C),l&&c&&l!==c&&await d.storage.from("images").remove([l])}catch(l){const c=l instanceof Error?l.message:"Failed to update portrait asset";v(c)}finally{R(!1)}},re=async e=>{if(!e.newValue.trim())return;const{data:t,error:o}=await d.from(e.base).insert({order_index:e.items.length+1}).select("id,order_index").single();if(o){u(o.message);return}const{error:l}=await d.from(e.translation).insert({[e.foreignKey]:t.id,language:n,[e.valueKey]:e.newValue.trim()});if(l){u(l.message);return}e.setNewValue(""),x(),await h()},ie=async(e,t)=>{const{error:o}=await d.from(e.translation).upsert({[e.foreignKey]:t.id,language:n,[e.valueKey]:t.value.trim()},{onConflict:`${e.foreignKey},language`});if(o){u(o.message);return}x(),await h()},ue=async(e,t)=>{const{error:o}=await d.from(e.base).delete().eq("id",t);if(o){u(o.message);return}x(),await h()},de=async()=>{if(!k.trim())return;const{data:e,error:t}=await d.from("about_languages").insert({order_index:U.length+1}).select("id,order_index").single();if(t){u(t.message);return}const{error:o}=await d.from("about_language_translations").insert({about_language_id:e.id,language:n,name:k.trim(),level:O.trim()||null});if(o){u(o.message);return}H(""),Y(""),x(),await h()},ce=async e=>{const{error:t}=await d.from("about_language_translations").upsert({about_language_id:e.id,language:n,name:e.name.trim(),level:e.level?.trim()||null},{onConflict:"about_language_id,language"});if(t){u(t.message);return}x(),await h()},me=async e=>{const{error:t}=await d.from("about_languages").delete().eq("id",e);if(t){u(t.message);return}x(),await h()};return f?a.jsx("div",{className:"flex items-center justify-center py-8",children:a.jsx(N,{translationKey:"admin.common.loading",as:"div",shimmerWidth:"120px",className:"text-[var(--text)]"})}):a.jsxs("div",{className:"space-y-8",children:[a.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[a.jsx("h2",{className:"text-[length:var(--font-600)] font-semibold text-[var(--text)]",children:a.jsx(N,{translationKey:"admin.about.title",as:"span",shimmerWidth:"200px"})}),a.jsx("select",{value:n,onChange:e=>i(e.target.value),className:"field",children:_e.map(e=>a.jsx("option",{value:e.code,children:e.label},e.code))})]}),p&&a.jsx("div",{className:"text-red-400 text-[length:var(--font-100)]",children:p}),a.jsx("p",{className:"text-[var(--text-muted)] text-[length:var(--font-100)]",children:r("admin.about.markdownHint")}),a.jsxs("div",{className:"space-y-3",children:[a.jsx("h3",{className:"text-[length:var(--font-400)] font-medium text-[var(--text)]",children:"Portrait Image"}),L&&a.jsx("div",{className:"text-red-400 text-[length:var(--font-100)]",children:L}),Z?a.jsx("div",{className:"text-[var(--text)]",children:a.jsx(N,{translationKey:"admin.common.loading",as:"span",shimmerWidth:"120px"})}):a.jsxs("div",{className:"space-y-2",children:[a.jsx(fe,{currentImage:_?.url??"",onUpload:oe,folder:"portrait",disabled:ee}),_?.url?a.jsxs("div",{className:"text-[length:var(--font-100)] text-[var(--text-muted)] break-all",children:["Current URL: ",_.url]}):null]})]}),le.map(e=>a.jsxs("div",{className:"space-y-3",children:[a.jsx("h3",{className:"text-[length:var(--font-400)] font-medium text-[var(--text)]",children:e.label}),a.jsx("div",{className:"space-y-2",children:e.items.map(t=>a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx("textarea",{value:t.value,onChange:o=>e.setItems(l=>l.map(c=>c.id===t.id?{...c,value:o.target.value}:c)),className:"field flex-1",rows:2}),a.jsx("button",{type:"button",onClick:()=>ie(e,t),className:"btn btn-primary",children:a.jsx(X,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:()=>ue(e,t.id),className:"btn btn-secondary",children:a.jsx(G,{className:"h-4 w-4"})})]},t.id))}),a.jsxs("div",{className:"flex items-start gap-2",children:[a.jsx("textarea",{value:e.newValue,onChange:t=>e.setNewValue(t.target.value),className:"field flex-1",rows:2,placeholder:r("admin.common.addNew")}),a.jsx("button",{type:"button",onClick:()=>re(e),className:"btn btn-primary",children:a.jsx(Q,{className:"h-4 w-4"})})]})]},e.id)),a.jsxs("div",{className:"space-y-3",children:[a.jsx("h3",{className:"text-[length:var(--font-400)] font-medium text-[var(--text)]",children:a.jsx(N,{translationKey:"about.languages.title",as:"span",shimmerWidth:"160px"})}),a.jsx("div",{className:"space-y-2",children:U.map(e=>a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[2fr_1fr_auto_auto] gap-2 items-start",children:[a.jsx("input",{value:e.name,onChange:t=>S(o=>o.map(l=>l.id===e.id?{...l,name:t.target.value}:l)),className:"field",placeholder:r("admin.about.languageName")}),a.jsx("input",{value:e.level??"",onChange:t=>S(o=>o.map(l=>l.id===e.id?{...l,level:t.target.value}:l)),className:"field",placeholder:r("admin.about.languageLevel")}),a.jsx("button",{type:"button",onClick:()=>ce(e),className:"btn btn-primary",children:a.jsx(X,{className:"h-4 w-4"})}),a.jsx("button",{type:"button",onClick:()=>me(e.id),className:"btn btn-secondary",children:a.jsx(G,{className:"h-4 w-4"})})]},e.id))}),a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-[2fr_1fr_auto] gap-2 items-start",children:[a.jsx("input",{value:k,onChange:e=>H(e.target.value),className:"field",placeholder:r("admin.about.languageName")}),a.jsx("input",{value:O,onChange:e=>Y(e.target.value),className:"field",placeholder:r("admin.about.languageLevel")}),a.jsx("button",{type:"button",onClick:de,className:"btn btn-primary",children:a.jsx(Q,{className:"h-4 w-4"})})]})]})]})}export{ke as AboutContentAdmin};
